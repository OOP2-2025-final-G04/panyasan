<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>注文管理システム</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='index-style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bakery-bg-pattern">
  <h1>注文管理システム</h1>

  <ul>
    <li><a href="{{ url_for('user.list') }}">ユーザー（顧客）</a></li>
    <li><a href="{{ url_for('product.list') }}">製品</a></li>
    <li><a href="{{ url_for('order.list') }}">注文</a></li>
    <li><a href="{{ url_for('point.consume') }}">ポイント消費</a></li>
  </ul>

  <!-- グラフエリア -->
  <div class="graph-container">

    <!-- 上段：2枠 -->
    <div class="graph-row-top">
<!-- グラフ①：年齢（年齢 × 性別） -->
<div class="graph-box">
  <canvas id="ageGenderChart"></canvas>
</div>

<!-- グラフ②：ユーザー別ポイント消費ランキング -->
<div class="graph-box">
  <section class="user_ranking">

    <h3 class="ranking-title">ポイント消費ランキング（TOP5）</h3>

    <div class="ranking-content">
      <!-- 左：円グラフ -->
      <div class="chart-area">
        <canvas id="user_ranking_chart" width="260" height="260"></canvas>
      </div>

      <!-- 右：ランキング表示 -->
      <div class="ranking-list">
        <ol>
          {% for name, value in ranking_data %}
          <li>{{ name }}：{{ value }} pt</li>
          {% endfor %}
        </ol>
      </div>
    </div>
  </section>
</div>

    </div>

  </section>
</div>


    <!-- 中段：1枠 -->
    <div class="graph-box">
      <h2 style="text-align: left; margin: 20px 0 15px 0;">パンの種類別売上</h2>
      <canvas id="productChart" width="600" height="300"></canvas>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // 製品データを取得してグラフを表示
    async function loadProducts() {
      try {
        const response = await fetch('/products/api');
        const data = await response.json();
        const sales = data.sales;

        // グラフ作成
        const ctx = document.getElementById("productChart");
        const productChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: sales.map(s => s.name),
            datasets: [{
              label: "売上（円）",
              data: sales.map(s => s.price),
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 10000,  // 最大10000円
                ticks: {
                  stepSize: 1000  // 1メモリ1000円、10個の目盛り
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error loading products:', error);
      }
    }

    // ページ読み込み時に実行
    loadProducts();
  </script>
    </div>


    <!-- 下段：1枠 -->
    <div class="graph-box">グラフ
      <canvas id="daily-sales-chart"></canvas>
    </div>

  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

  /* ===== グラフ①：年齢 × 性別 ===== */
  fetch('/api/stats/age-gender')
    .then(res => res.json())
    .then(data => {
      const ctx = document.getElementById('ageGenderChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: data.datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            title: { display: true, text: '年代別・性別ユーザー構成' },
            legend: { position: 'bottom' }
          }
        }
      });
    })
    .catch(() => {
      document.querySelector('#ageGenderChart')
        .parentElement.innerText = 'グラフの読み込みに失敗しました';
    });

  /* ===== グラフ②：ポイント消費ランキング（円グラフ） ===== */
  const userLabels = {{ labels | tojson }};
  const userValues = {{ values | tojson }};

  const rankingCtx = document
    .getElementById('user_ranking_chart')
    .getContext('2d');

  new Chart(rankingCtx, {
    type: 'pie',
    data: {
      labels: userLabels,
      datasets: [{
        data: userValues,
        radius: '80%'
      }]
    },
    options: {
      responsive: false,
      plugins: {
        legend: { display: false }
      }
    }
  });

  /* ===== グラフ④：日別売上 ===== */
  fetch('/orders/api/sales/daily')
    .then(res => res.json())
    .then(json => {
      const ctx = document.getElementById('daily-sales-chart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: json.labels,
          datasets: [{
            label: '日別売上',
            data: json.data,
            fill: false,
            tension: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: '日別売上（円）' }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    });

});
</script>


</body>
</html>

